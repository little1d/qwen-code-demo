# RWE分析任务：测试Qwen Code Agent能力

本项目设计了一个真实世界证据（Real World Evidence, RWE）分析任务，用于测试和验证 Qwen Code Agent 在复杂数据分析任务中的能力。

## 项目结构

```
qwen-code/
├── README.md                    # 项目说明
├── SYSTEM_PROMPT.md             # System Prompt（一次性提供给Agent）
├── TASKS.md                     # 分步任务列表（按顺序提供给Agent）
├── requirements.txt             # Python依赖包
├── data/                        # 数据目录
│   ├── generate_rwe_data.py     # 数据生成脚本
│   ├── verify_data.py          # 数据验证脚本
│   ├── patient_demographics.csv # 患者人口统计学数据
│   ├── diagnoses.csv            # 诊断记录
│   ├── prescriptions.csv        # 处方记录
│   ├── medical_events.csv       # 医疗事件记录
│   ├── costs.csv                # 费用记录
│   └── data_dictionary.json     # 数据字典
```

## 快速开始

### 1. 生成模拟数据

首先进入data目录并运行数据生成脚本：

```bash
cd data
python generate_rwe_data.py
```

这将生成5个CSV文件和一个数据字典JSON文件。

### 2. 验证数据

验证生成的数据是否正确：

```bash
python verify_data.py
```

### 3. 使用提示词测试Agent

#### 步骤1：提供System Prompt

将 `SYSTEM_PROMPT.md` 的内容提供给Qwen Code Agent，等待Agent回复"1"确认理解。

#### 步骤2：分步提供任务

按照 `TASKS.md` 中的任务顺序，逐个提供给Agent：

1. **任务1：数据准备与患者识别**
2. **任务2：两组医疗方案基线特征描述**
3. **任务3：倾向性评分匹配（PSM）**
4. **任务4：结局分析**
5. **任务5：结果可视化与报告生成**

每个任务完成后，可以验证Agent的输出，然后继续下一个任务。

### 4. Agent需要完成的核心任务

1. **数据准备与队列构建** - 处理多表数据，识别符合条件的患者
2. **基线特征描述** - 描述性统计分析
3. **倾向性评分匹配** - 处理选择偏倚，实现PSM方法
4. **结局分析** - 医疗资源利用、成本、治疗模式的比较分析
5. **结果可视化与报告** - 生成图表和分析报告

## 技术栈要求

- Python 3.7+
- pandas, numpy
- scipy, statsmodels（统计分析）
- matplotlib, seaborn（可视化）
- lifelines（生存分析，可选）

## 评估维度

评估Agent在以下方面的表现：

1. **代码质量** (20%)
   - 代码可读性和模块化
   - 注释和文档
   - 错误处理

2. **方法正确性** (40%)
   - 统计方法选择是否恰当
   - 分析逻辑是否正确
   - 假设检验使用是否合理

3. **结果完整性** (30%)
   - 是否覆盖所有要求
   - 结果计算是否准确
   - 输出格式是否规范

4. **结果解释** (10%)
   - 统计结果的解释是否专业
   - 临床意义的理解是否合理

## 数据特征

生成的数据模拟真实的Claims数据，包含：

- **2000名患者**
- **时间范围**：2018-2023年
- **随访期**：12个月
- **内置真实效应**：Treatment A (新治疗方案) 相比 Treatment B (标准治疗) 有：
  - 更低的急诊就诊率
  - 更低的住院率
  - 更好的治疗依从性
  - 更高的药物成本，但总医疗成本可能更低

## 使用场景

这个任务设计用于：

1. **评估代码生成能力** - Agent是否能生成完整、可运行的分析代码
2. **评估统计方法理解** - Agent是否理解RWE研究的统计方法需求
3. **评估分步任务执行** - Agent是否能按步骤完成复杂任务，并在每个步骤保持上下文
4. **评估结果解释能力** - Agent是否能正确理解并解释统计结果
5. **评估模块化设计** - Agent是否能将分析任务分解为可复用的代码模块

## 测试方式

### 方式1：完整流程测试

一次性提供所有任务，评估Agent的整体规划能力。

### 方式2：分步测试（推荐）

按顺序提供任务，每个任务完成后验证：

- Agent是否能正确理解每个任务
- Agent是否能利用前面步骤的结果
- Agent的代码质量和逻辑是否正确
- Agent是否能处理任务间的依赖关系

## 注意事项

- 这是一个**模拟数据集**，仅用于测试分析能力，不应用于实际医学决策
- 数据中已内置了治疗效果差异，Agent应该能够检测到这些差异
- 倾向性评分匹配需要适当的协变量平衡评估
- 所有统计方法的选择应该有充分的理论依据

## 后续扩展

可以考虑添加：

- 更多的患者或更长的随访期
- 更复杂的合并症模式
- 处理缺失数据的场景
- NLP任务（如果加入EMR文本数据）
