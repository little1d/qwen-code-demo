# RWE分析任务 - 分步任务列表

以下任务将按顺序提供给Agent，每个任务完成后进行验证。

---

## 任务1：数据准备与患者识别

### 任务描述

- 加载并整合所有数据文件
- 识别符合研究条件的患者：
  - 在2018-2023年间首次诊断目标疾病（`is_target_disease=True`）
  - 有目标药物处方记录（`is_target_drug=True`）
  - 有完整12个月随访数据
- 根据首次用药日期定义：
  - 基线期：首次用药前90天
  - 随访期：首次用药后365天
- 根据`treatment_group`字段将患者分为暴露组（DRUG_A）和对照组（DRUG_B）

### 预期输出（用 task1 文件夹包裹)

- 清理后的数据集
- 符合条件的患者队列列表
- 每个患者的基线期和随访期定义

---

## 任务2：两组医疗方案基线特征描述

### 任务描述

计算并比较两组的基线特征：

- 年龄、性别、地区分布
- 合并症数量和类型（从diagnoses表中识别`is_target_disease=False`的记录）
- 基线期内的医疗资源利用

### 预期输出（用 task2 文件夹包裹)

- 基线特征描述性统计表
- 两组基线特征比较（统计检验结果）

---

## 任务3：倾向性评分匹配（PSM）

### 任务描述

- 使用逻辑回归建立倾向性评分模型（包含年龄、性别、合并症数量等协变量）
- 执行1:1最近邻匹配（caliper=0.1）
- 评估匹配后的协变量平衡性（标准化差异 < 0.1）

### 预期输出（用 task3 文件夹包裹)

- 倾向性评分模型结果
- 匹配后的患者对列表
- 匹配前后协变量平衡性比较表

---

## 任务4：结局分析

### 4.1 医疗资源利用

计算随访期内的：

- 急诊就诊次数（ER事件）
- 住院次数（Hospitalization事件）
- 住院天数总和
- 门诊就诊次数（Outpatient事件）

使用适当的统计方法比较两组差异（考虑数据分布选择合适的检验）。

### 4.2 成本分析

- 总医疗费用（所有cost_type的费用总和）
- 处方费用（Prescription类型的费用）
- 比较两组成本差异

### 4.3 治疗依从性（PDC）

计算每个患者的PDC（Proportion of Days Covered）

- PDC = (随访期内总用药天数 / 随访天数) × 100%
- 用药天数从`prescriptions`表中计算（考虑`days_supply`和处方日期）
- 定义依从性良好：PDC ≥ 80%

### 4.4 治疗持续性

- 定义停药：连续60天无目标药物处方
- 使用Kaplan-Meier方法估计停药风险
- Log-rank test比较两组
- 绘制生存曲线

### 预期输出（用 task4 文件夹包裹)

- 所有结局指标的统计结果表
- 统计检验结果（p值、效应量等）
- 相关可视化图表

---

## 任务5：结果可视化与报告生成

### 任务描述

生成以下可视化：

1. 基线特征平衡表（匹配前后）
2. 医疗资源利用对比图
3. 成本对比图
4. Kaplan-Meier生存曲线
5. 主要结局统计表

最后生成一份分析报告摘要（Markdown格式），包括：

- 研究方法简述
- 主要发现
- 局限性说明

### 预期输出（用 task5 文件夹包裹)

- 所有可视化图表（PNG格式）
- 分析报告（Markdown格式）

---

## 使用说明

每个任务可以单独提供给Agent，格式如下：

**对于任务1：**

```
请完成以下任务：

任务1：数据准备与患者识别

[复制任务1的内容]
```

**对于任务2：**

```
请完成以下任务：

任务2：两组医疗方案基线特征描述

[复制任务2的内容]
```

以此类推。
